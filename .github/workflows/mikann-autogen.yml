name: mikann-autogen
on:
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read

concurrency:
  group: mikann-autogen
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: gpt-5-mini
      OPENAI_MAX_OUTPUT_TOKENS: "1200"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run generator
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pwsh -NoProfile -File automation/run.ps1

      - name: Commit & push (with frozen guards + retry)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          git config user.name "mikann-autogen"
          git config user.email "actions@users.noreply.github.com"

          git add -A

          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No changes"
            exit 0
          }

          # frozen paths guard
          $bad = git diff --cached --name-only | Select-String -Pattern '^(toolbox/|ai-subscription-trouble-guide/|sns-growth-rank/|hub/index\.html|hub/assets/app\.v3\.js|hub/assets/ui\.v3\.css)' | ForEach-Object { $_.Line }
          if ($bad) {
            Write-Host "NG: frozen paths touched:"
            $bad | ForEach-Object { Write-Host $_ }
            exit 1
          }

          # hub/assets guard (allow only sites.json)
          $bad2 = git diff --cached --name-only | Select-String -Pattern '^hub/assets/' | ForEach-Object { $_.Line } | Where-Object { $_ -ne 'hub/assets/sites.json' }
          if ($bad2) {
            Write-Host "NG: forbidden hub/assets change:"
            $bad2 | ForEach-Object { Write-Host $_ }
            exit 1
          }

          git commit -m "chore: autogen update" | Out-Host

          # integrate remote updates (avoid non-fast-forward)
          for ($i=0; $i -lt 5; $i++) {
            git pull --rebase origin main
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds (2 + $i)
          }

          # push retry
          for ($i=0; $i -lt 5; $i++) {
            git push
            if ($LASTEXITCODE -eq 0) { exit 0 }
            Start-Sleep -Seconds (2 + $i)
          }

          throw "push failed after retries"


          git commit -m "chore: bootstrap autogen workflow"
          git push
